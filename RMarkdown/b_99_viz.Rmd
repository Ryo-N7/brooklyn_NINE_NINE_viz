---
title: "Untitled"
author: "RN7"
date: "February 2, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

- hey there criminal, it's me johnny law!
- Terry loves `ggplot2`!
- yippie-kayak other buckets!
- Noice. Toit.


# Packages

```{r warning=FALSE, message=FALSE}
pacman::p_load(tidyverse, rvest, glue, cowplot,
               polite, extrafont, scales, gridExtra)
loadfonts()
```

# B99 theme

First, let me create a custom Brooklyn NINE NINE theme that I can put on all of my plots. This will save me time from typing in the same options over and over again!

I googled what the font type that the official Brooklyn Nine Nine media used, downloaded them, and got it installed for R using the `extrafont` package.

```{r}
theme_b99 <- function(){
  
  base_size <- 11
  half_line <- base_size / 2
  
  theme_minimal() %+replace%
    theme(text = element_text(family = "Univers", color = "#F9FEFF",
                              face = "plain", size = 14, 
                              hjust = 0.5, vjust = 0.5, angle = 0,
                              lineheight = 0.9, 
                              margin = margin(half_line, half_line,
                                              half_line, half_line),
                              debug = FALSE),
          plot.title = element_text(family = "Univers LT 93 ExtraBlackEx",
                                    size = 20, color = "#F9FEFF"),
          plot.background = element_rect(color = NA, fill = "#0053CD"), 
          panel.background = element_rect(color = NA, fill = "#0053CD"),
          # axis options
          axis.text = element_text(family = "Univers", color = "#F9FEFF", size = 12),
          axis.title = element_text(size = 14),
          # legend options (for ratings plot)
          legend.title = element_text(family = "Univers", color = "#F9FEFF"),
          legend.text = element_text(family = "Univers", color = "#F9FEFF",
                                     size = 9),
          legend.position = "bottom",
          legend.key = element_rect(colour = "black", linetype = "solid", size = 1.5),
          legend.background = element_rect(color = "black", fill = "#0053CD",
                                           linetype = "solid"))
}
```



# Episode ratings

Calling `as_tibble()` on a vector is discouraged, because the behavior is likely to change in the future. Use `enframe(name = NULL)` instead.

As in my more [recent]() blog posts I will use the `polite` package to web scrape responsibly.

```{r}
url_df <- tibble(
  urls = c("https://www.imdb.com/title/tt2467372/episodes?season=1",
           "https://www.imdb.com/title/tt2467372/episodes?season=2",
           "https://www.imdb.com/title/tt2467372/episodes?season=3",
           "https://www.imdb.com/title/tt2467372/episodes?season=4",
           "https://www.imdb.com/title/tt2467372/episodes?season=5"),
  season_num = c(1, 2, 3, 4, 5)) 

# scraping function:
brooklyn99_ep_rating <- function(url) {
  
  session <- bow(url)
  url2 <- scrape(session)
  
  # Grab episode names
  sX_ep_name <- url2 %>% 
    html_nodes(".info a") %>% 
    html_text() %>% 
    enframe(name = value) %>% 
    mutate(value = gsub("\\n", "", x = value))
  
  # Grab episode rating
  sX_rate <- url2 %>% 
    html_nodes(".ipl-rating-widget > .ipl-rating-star .ipl-rating-star__rating") %>% 
    html_text() %>% 
    enframe(name = value) %>% 
    mutate(value = gsub("\\n", "", x = value) %>% as.numeric)
  
  # Clean episode name df
  sX_ep_name <- sX_ep_name %>% 
    mutate(title = trimws(value)) %>% 
    filter(!str_detect(title, "Rate"), title != "") %>% 
    select(-value)
  
  # combine name + rating
  ep_rating <- sX_ep_name %>% 
    bind_cols(sX_rate)
}

brooklyn99_ep_rating_df <- map2(.x = url_df$urls, .y = url_df$season_num,
                          ~ brooklyn99_ep_rating(url = .x) %>% 
         mutate(season = .y)) %>% 
  reduce(rbind)

#saveRDS(brooklyn99_ep_rating_df, "../data/brooklyn99_ep_rating_df.RDS")
ep_rating_df <- readRDS("../data/brooklyn99_ep_rating_df.RDS")
```

```{r}
ep_rating_df %>% 
  arrange(desc(value)) %>% 
  head(10)

library(infer)


# check variances

ep_rating_df %>% 
  mutate(season = as_factor(as.character(season))) %>% 
  filter(season %in% c(1, 5)) -> ep_rating_short

car::leveneTest(value ~ season, data = ep_rating_short)
kruskal.test(value ~ season, data = ep_rating_short)
```





```{r}
ep_rating_df %>% 
  filter(season %in% c(1, 5)) %>% 
  group_by(season) %>% 
  summarise(avg_rating = mean(value)) %>% 
  mutate(diff_means = avg_rating - lead(avg_rating))

# diff means
ep_rating_df %>% 
  mutate(season = as_factor(as.character(season))) %>% 
  filter(season %in% c(1, 5)) %>% 
  specify(value ~ season) %>% 
  calculate("diff in means", order = c(5, 1)) -> diff_means

# bootstrap means
ep_rating_df %>% 
  mutate(season = as_factor(as.character(season))) %>% 
  filter(season %in% c(1, 5)) %>% 
  specify(value ~ season) %>% 
  generate(reps = 1000, type = "bootstrap") %>% 
  calculate("diff in means", order = c(5, 1)) -> boot_means

bootstrap_confint <- boot_means %>% get_confidence_interval()

boot_means %>% 
  visualise() +
  shade_confidence_interval(bootstrap_confint,
                            color = "red", fill = "blue") +
  geom_vline(xintercept = diff_means$stat, size = 1, color = "green") +
  theme_minimal()

ep_rating_df %>% 
  mutate(season = as_factor(as.character(season))) %>% 
  filter(season %in% c(1, 5)) %>% 
  specify(value ~ season) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 5000, type = "permute") %>% 
  calculate("diff in means", order = c(5, 1)) -> diffs_null

diffs_null %>% 
  visualize() +
  geom_vline(xintercept = diff_means$stat, size = 1, color = "blue") +
  scale_y_continuous(labels = comma) +
  theme_minimal()

diffs_null %>% 
  get_p_value(obs_stat = diff_means, direction = "both") %>% 
  mutate(p_value_clean = pvalue(p_value))
```



## ratings plot

Here I used the `dichromat` package for the color scheme "LightBluetoDarkBlue.10". It meshes pretty well with the Brooklyn 99 color theme!

- low = "#c6dbef", high = "#0040FF", # low = "#E6FFFF", high = "#0040FF"

```{r}
rating_plot <- ep_rating_df %>% 
  group_by(season) %>% 
  mutate(ep_num = row_number()) %>% 
  ungroup() %>% 
  ggplot(aes(x = ep_num, y = season)) +
  geom_tile(aes(fill = value), size = 1.5,
            color = "black") +
  scale_fill_gradientn("Rating", colors = dichromat::colorschemes$LightBluetoDarkBlue.10,
                       breaks = c(7.7, 8, 8.5, 9, 9.5)) +
  guides(fill = guide_colourbar(frame.colour = "black",
                                barwidth = unit(2, "in"))) +
  scale_x_continuous(expand = c(0.01, 0.01), 
                     breaks = c(1, seq(from = 5, to = 20, by = 5), 23),
                     labels = c(1, seq(from = 5, to = 20, by = 5), 23)) +
  scale_y_reverse(expand = c(0.01, 0.01),
                  breaks = c(1:7), 
                  labels = c(1:7)) +
  labs(x = "Episode Number", y = "Season",
       title = "Brooklyn Nine-Nine",
       caption = glue("
                      Source: IMDB
                      @R_By_Ryo")) +
  theme_b99() +
  theme(panel.grid = element_blank())

rating_plot
```


# Cast appearances


```{r}
cast_url <- bow("https://www.imdb.com/title/tt2467372/fullcredits?ref_=tt_cl_sm#cast")

cast_info_raw <- scrape(cast_url) %>% 
  html_nodes(".character") %>% 
  html_text() %>% 
  as_tibble()

cast_info_clean <- cast_info_raw %>% 
  separate(value, into = c("blank", "name", "episode_num", "dots"), sep = "\n") %>% 
  mutate(episode_num = case_when(
    episode_num == "         / ...  " ~ dots,
    TRUE ~ episode_num),
    episode_num = episode_num %>% word(., 1, sep = "e") %>% as.numeric,
    name = str_trim(name, side = "both")) %>% 
  select(-blank, -dots) %>% 
  mutate(name = case_when(
    name == "Captain Ray Holt" ~ "Ray Holt",
    name == "Scully" ~ "Norm Scully",
    name == "Hitchcock" ~ "Michael Hitchcock",
    name == "Deputy Chief Madeline Wuntch" ~ "Madeline Wuntch",
    TRUE ~ name))
  
# MAIN cast
cast_main_url <- bow("https://en.wikipedia.org/wiki/List_of_Brooklyn_Nine-Nine_characters")

cast_main_raw <- scrape(cast_main_url) %>% 
  html_nodes(".wikitable") %>% 
  html_table(fill = TRUE) %>% 
  flatten_df() %>% 
  as_tibble()

cast_main_clean <- cast_main_raw %>% 
  slice(-1) %>% 
  select(Character)

# save
#saveRDS(cast_info_clean, "../data/cast_info_clean.RDS")
cast_info_clean <- readRDS("../data/cast_info_clean.RDS")

#saveRDS(cast_main_clean, "../data/cast_main_clean.RDS")
cast_main_clean <- readRDS("../data/cast_main_clean.RDS")

# anti-join
non_main_cast <- anti_join(cast_info_clean, cast_main_clean, by = c("name" = "Character"))
```

## cast plot

I create a "halfway" variable so that the number labels will appear right in the middle of each bar. Using the `axis_canvas()`, `draw_image()`, and `insert_axis_grob()` from the `cowplot` package I can insert images of the characters along the bottom of the plot.

"1" = "#6CA9C3", "2" = "#3A3533", 
          "3" = "#000E33"

```{r fig.height = 6, fig.width = 10}
non_main_plot <- non_main_cast %>% 
  arrange(desc(episode_num)) %>% 
  head(5) %>% 
  mutate(halfway = episode_num / 2) %>% 
  ggplot(aes(x = reorder(name, desc(episode_num)), y = episode_num)) +
  geom_col(fill = "#000E33") +
  geom_text(aes(y = halfway, label = episode_num,
                family = "Univers"),
            color = "#F9FEFF",
            size = 8) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 12.5),
                     breaks = c(2, 4, 6, 8, 10, 12),
                     labels = c(2, 4, 6, 8, 10, 12)) +
  labs(title = "Most appearances by non-main cast", 
       x = NULL, y = "Number of Episodes",
       caption = glue("
                      Source: IMDB
                      @R_By_Ryo")) +
  theme_b99() +
  theme(panel.grid.major.x = element_blank())

# images
pimage <- axis_canvas(non_main_plot, axis = 'x') + 
  draw_image("https://vignette.wikia.nocookie.net/tvdatabase/images/d/d5/Adrian_Pimento.jpg", 
             x = 0.5, scale = 0.9) +
  draw_image("https://vignette.wikia.nocookie.net/brooklynnine-nine/images/a/ab/Kevin.jpg", 
             x = 1.5, scale = 0.9) +
  draw_image("https://vignette.wikia.nocookie.net/brooklynnine-nine/images/b/b3/Wuntch.png", 
             x = 2.5, scale = 0.9) +
  draw_image("https://vignette.wikia.nocookie.net/brooklynnine-nine/images/2/23/Vulture.jpg", 
             x = 3.5, scale = 0.9) +
  draw_image("https://vignette.wikia.nocookie.net/brooklynnine-nine/images/0/0a/Doug_Judy.png",
             x = 4.5, scale = 0.9)

# insert the image strip into the bar plot and draw  
ggdraw(insert_xaxis_grob(non_main_plot, pimage, position = "bottom"))
```

Adrian has appeared in the most episodes just beating out Kevin. This really shows how involved Adrian was in the story in Season 4 and 5 especially compared to Kevin who has periodically appeared since the first season.

Everybody's favorite DOUG JUDY rounds off this bar chart.

![doug judy singing gif]()



# Viewer numbers

```{r}
url_wiki_df <- tibble(
  urls = c("https://en.wikipedia.org/wiki/Brooklyn_Nine-Nine_(season_1)",
           "https://en.wikipedia.org/wiki/Brooklyn_Nine-Nine_(season_2)",
           "https://en.wikipedia.org/wiki/Brooklyn_Nine-Nine_(season_3)",
           "https://en.wikipedia.org/wiki/Brooklyn_Nine-Nine_(season_4)",
           "https://en.wikipedia.org/wiki/Brooklyn_Nine-Nine_(season_5)"),
  season_num = c(1, 2, 3, 4, 5))

brooklyn99_ep_info <- function(url) {
  
  session <- bow(url)
  
  episode_raw <- scrape(session) %>% 
    html_nodes(".wikiepisodetable") %>% 
    html_table(fill = TRUE) %>% 
    flatten_df() %>% 
    as_tibble() %>% 
    filter(row_number() %% 2 != 0)
  
  episode_table <- episode_raw %>% 
  set_names(c("num_overall", "num_season", "title", "director", "writer",
              "air_date", "prod_code", "viewers")) %>% 
  mutate(viewers = str_remove_all(viewers, "\\[[0-9]+\\]") %>% as.numeric)
  
}

b99_ep_info_df <- map2(.x = url_wiki_df$urls, .y = url_wiki_df$season_num,
                          ~ brooklyn99_ep_info(url = .x) %>% 
         mutate(season = .y)) %>% 
  reduce(rbind)

# saveRDS(b99_ep_info_df, "../data/b99_ep_info_df.RDS")
b99_ep_info_df <- readRDS("../data/b99_ep_info_df.RDS")
```

- use `separate_rows()` for writers and directors?


```{r}
b99_ep_info_df %>% 
  select(season, num_season, title, num_overall, writer, viewers) %>% 
  separate_rows(writer, sep = "&") %>% 
  mutate(writer = writer %>% trimws) %>% 
  #select(writer) %>% unique() %>% 
  group_by(writer) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n))
  #add_count(writer)
```

```{r}
b99_ep_info_df %>% 
  select(season, num_season, title, num_overall, director, viewers) %>% 
  separate_rows(director, sep = "&") %>% 
  mutate(director = director %>% trimws) %>% 
  group_by(director) %>% 
  summarize(n = n(),
            avg_viewers = mean(viewers)) %>% 
  arrange(desc(avg_viewers))
```


## viewers plot

- The Fugitive episodes are formatted differently... WHYYYY.gif
- there are other multi-part episodes but this is the only one that aired on the same day on New Years Day 2017

At the end I create a `first` and `last` variable for each season taking note of what overall number the first and last episodes of a season were. You'll see why I did this soon.

```{r fig.height = 4, fig.width = 10}
viewers_df <- b99_ep_info_df %>% 
  select(season, num_season, title, num_overall, viewers) %>% 
  # manually fix The Fugitive episodes
  filter(num_overall != 7980) %>% 
  add_row(season = 4, num_season = 11, title = "The Fugitive: Part 1", 
          num_overall = 79, viewers = 3.49) %>% 
  add_row(season = 4, num_season = 12, title = "The Fugitive: Part 2", 
          num_overall = 80, viewers = 3.49) %>% 
  mutate(num_overall = as.numeric(num_overall),
         num_season = as.numeric(num_season),
         season = as_factor(as.character(season))) %>% 
  arrange(num_overall) %>% 
  group_by(season) %>% 
  mutate(first = first(num_overall),
         last = last(num_overall)) %>% 
  ungroup() 

cols <- c("1" = "#6CA9C3", "2" = "#3A3533", 
          "3" = "#000E33", "4" = "#CBCFD2", "5" = "#175E78")
# yellow: #FCF40E
# dark grey: #3A3533
# light teal: #6CA9C3
# black: #0F0E0E
# navy: #175E78
```

I use `geom_rect()` here to give a colored background for each season. Setting the span of the Xs as the first and last of each season and then using Inf and -Inf for the Ys to cover the entire height of the plot.

For the season labels i calculated the midpoint along the x-axis per each season and used that as the x values (not shown in the code). I could have used facets but to the best of my knowledge I wouldn't have been able to place the labels on top across multiple facets anyways. Probably possible by placing text grobs on top of the facetted plot but I thought that would take more time compared to what I did with `geom_rect()`.

```{r fig.height = 6, fig.width = 11}
viewer_plot <- viewers_df %>% 
  ggplot(aes(x = num_overall, y = viewers, group = season)) +
  geom_rect(aes(xmin = first, xmax = last,
                fill = season), alpha = 0.2,
            ymin = -Inf, ymax = Inf) +
  geom_line(color = "white", size = 1.1) +
  scale_fill_manual("Season", values = cols, guide = FALSE) +
  scale_y_continuous(limits = c(0, 20),
                     breaks = c(seq(0, 15, by = 5)),
                     expand = c(0, 0)) +
  scale_x_continuous(breaks = c(seq(0, 112, by = 5)),
                     labels = c(seq(0, 112, by = 5)),
                     expand = c(0, 0)) +
  labs(x = "Episode Number (Overall)", y = "Viewers (Millions)",
       title = "Viewers by Episode",
       caption = glue("
                      Source: Nielsen Media Research
                      @R_By_Ryo")) +
  theme_b99() +
  theme(panel.grid = element_blank()) +
  # Line segments
  annotate(geom = "segment", x = 15, xend = 15, y = 15, yend = 16., 
           color = "black", size = 1.2) +
  annotate(geom = "segment", x = 34, xend = 34, y = 6, yend = 7, 
           color = "black", size = 1.2) +
  annotate(geom = "segment", x = 79.5, xend = 79.5, y = 3.5, yend = 5, 
           color = "black", size = 1.2) +
  # Episode details
  annotate(geom = "label", x = 7, y = 16.5, hjust = 0, size = 4.5,
           family = "Univers",
           label = "Operation: Broken Feather (Aired after Super Bowl XLVIII)") +
  annotate(geom = "label", x = 25, y = 7.5, hjust = 0, size = 4.5, 
           family = "Univers",
           label = "Beach House (Sunday before First Workday of 2015)") +
  annotate(geom = "label", x = 67, y = 5, hjust = 0, size = 4.5,
           family = "Univers",
           label = "The Fugitive: Part 1 & 2 (New Years Day 2017)") +
  # Season titles
  annotate(geom = "label", x = 11.5, y = 19, size = 7,
           family = "Univers",
           label = "Season One") +
  annotate(geom = "label", x = 34, y = 19, size = 7,
           family = "Univers",
           label = "Season Two") +
  annotate(geom = "label", x = 57, y = 19, size = 7,
           family = "Univers",
           label = "Season Three") +
  annotate(geom = "label", x = 79.5, y = 19, size = 7,
           family = "Univers",
           label = "Season Four") +
  annotate(geom = "label", x = 102, y = 19, size = 7,
           family = "Univers",
           label = "Season Five") 

viewer_plot
```

not sure about the Season 3 episodes

although one of them was a Halloween episode which fights with the Pontiac Bandit for best recurring episode
but in terms of the actual dates that those episodes aired I can't quite remember anything significant happening.


# colors & fonts

- dichromat: lightbluetodarkblue.10
-RColorBrewer: Blues

```{r}
# yellow: #FCF40E
# dark grey: #3A3533
# light teal: #6CA9C3
# black: #0F0E0E
# navy: #175E78
# title navy: #000E33
# grey: #CBCFD2
# white: #F9FEFF
# blue: #0053CD


```

```{r message=FALSE}
#loadfonts(device = "win")

ggplot(mtcars, aes(x = mpg, y = vs)) +
  geom_point(size = 2.5) +
  ggtitle("Brooklyn\nNine-Nine") +
  theme_minimal() +
  theme(title = element_text(family = "Univers LT 93 ExtraBlackEx",
                            color = "#F9FEFF"),
        axis.title = element_text(color = "#F9FEFF", family = "Roboto Condensed",
                                  size = 15, face = "bold"),
        axis.text = element_text(color = "#F9FEFF", family = "Roboto Condensed",
                                 size = 12),
        plot.background = element_rect(fill = "#0053CD")) +
  annotate(geom = "text", x = 25, y = 0.5, size = 10,
           color = "#000E33",
           label = "Brooklyn\nNine-Nine", family = "Univers") +
  annotate(geom = "point", x = 20, y = 0.75, 
           color = "#FCF40E", fill = "#FCF40E", size = 3.5) +
  annotate(geom = "point", x = 15, y = 0.75, 
           color = "red", size = 3.5) +
  annotate(geom = "point", x = 10, y = 0.75, 
           color = "#3A3533", size = 3.5) +
  annotate(geom = "point", x = 22.5, y = 0.75, 
           color = "#CBCFD2", size = 3.5) +
  annotate(geom = "point", x = 17.5, y = 0.75, 
           color = "orange", size = 3.5) +
  annotate(geom = "point", x = 12.5, y = 0.75, 
           color = "#0F0E0E", size = 3.5) +
  annotate(geom = "point", x = 25, y = 0.75, 
           color = "brown", size = 3.5)

```


# text boxes etc.

```{r}

```

```{r fig.width = 12, fig.height = 5.5}
#library(shadowtext)

rect <- data.frame(id = as.factor(c(1, 1, 1, 1,
                          2, 2, 2, 2)),
                   x = c(12, 12, 0,  0,
                         12, 12, 5.1,  4.9),
                   y = c(5.1, 2, 0.4,  3.5,
                         2.3, 0.95, 0,  1.3))

# rect2 <- data.frame(id = c(1, 1, 1, 1),
#                    x = c(12, 12, 5.1,  4.9),
#                    y = c(2.3, 0.95, 0,  1.3))

header <- ggplot(data = rect, aes(x, y, group = id, fill = id)) +
  geom_polygon() +
  scale_fill_manual(values = c("#0053CD", "#000E33"), guide = FALSE) +
  #geom_polygon(data = rect2, aes(x, y, group = id), fill = "#000E33") +
  annotate(geom = "text", y = 2, x = 0.4, hjust = 0,
           family = "Univers LT 93 ExtraBlackEx", 
           color = "#fcf7e8", size = 35, angle = 7.5,
           label = glue("
                        BROOKLYN")) +
  annotate(geom = "text", y = 0.7, x = 5.25, hjust = 0,
           family = "Univers", 
           color = "#fcf7e8", size = 25, angle = 7.5,
           label = glue("
                        NINE-NINE")) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 12)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 5.5)) +
  theme_void() +
  theme(plot.background = element_rect(color = "#F9FEFF", 
                                       fill = "#F9FEFF", # "#1A5E1FFF" "#CCFFBB"
                                       size = 8))

header
```



# composition

```{r}
?cowplot::plot_grid()
grid::textGrob()
grid::circleGrob()
```

